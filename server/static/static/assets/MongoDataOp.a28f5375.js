import{m as g}from"./api.4533990e.js";import{i as J,n as W,b as Ee}from"./assert.d82c837d.js";import{f as ke}from"./format.fd72f709.js";import{t as we}from"./api.359a68e0.js";import{d as Ne,u as Te,r as xe,c as Fe,t as Pe,L as he,h as d,i as c,j as _,q as p,k as o,w as s,l as u,Q as D,R as V,m as v,G as I,F as O,s as Ie,v as N,E as C}from"./index.3ab9ca99.js";import{_ as X}from"./MonacoEditor.1b395942.js";import"./Api.7cd1a1f8.js";const Oe={class:"toolbar"},je={style:{float:"left"}},Se={style:{float:"right",color:"#8492a6","margin-left":"6px","font-size":"13px"}},Ue={style:{float:"left"}},qe={style:{float:"right",color:"#8492a6","margin-left":"4px","font-size":"13px"}},Je={style:{padding:"3px",float:"right"},class:"mr5 mongo-doc-btns"},$e=p("div",{style:{"text-align":"center","margin-top":"10px"}},null,-1),Ke=Ne({__name:"MongoDataOp",setup(Me){const $=Te(),M=xe(null),e=Fe({tags:[],mongoList:[],query:{tagPath:null},mongoId:null,database:"",collection:"",activeName:"",databases:[],collections:[],dataTabs:{},findDialog:{visible:!1,findParam:{limit:0,skip:0,filter:"",sort:""}},insertDocDialog:{visible:!1,doc:""},jsoneditorDialog:{visible:!1,doc:"",item:{}}}),{tags:Y,mongoList:Z,query:A,mongoId:T,database:j,collection:S,activeName:B,databases:ee,collections:ae,dataTabs:le,findDialog:m,insertDocDialog:E,jsoneditorDialog:x}=Pe(e),L=async()=>{Ee(e.query.tagPath,"\u8BF7\u5148\u9009\u62E9\u6807\u7B7E");const t=await g.mongoList.request(e.query);e.mongoList=t.list},te=t=>{e.databases=[],e.collections=[],e.mongoId=null,e.collection="",e.database="",e.dataTabs={},t!=null&&L()},oe=async()=>{e.tags=await we.getAccountTags.request(null)},ne=()=>{e.databases=[],e.collections=[],e.dataTabs={},R()},R=async()=>{const t=await g.databases.request({id:e.mongoId});e.databases=t.Databases},se=()=>{e.collections=[],e.collection="",e.dataTabs={},z()},z=async()=>{e.collections=await g.collections.request({id:e.mongoId,database:e.database})},ue=()=>{const t=e.collection;if(!e.dataTabs[t]){const n={filter:"{}",sort:'{"_id": -1}',skip:0,limit:12},i={name:t,datas:[],findParamStr:JSON.stringify(n),findParam:n};e.dataTabs[t]=i}e.activeName=t,k(t)},ie=t=>{const a=Object.keys(e.dataTabs);for(let n=0;n<a.length;n++)t==a[n]&&M.value[n].blur();e.findDialog.findParam=e.dataTabs[t].findParam,e.findDialog.visible=!0},de=()=>{e.dataTabs[e.activeName].findParam=e.findDialog.findParam,e.dataTabs[e.activeName].findParamStr=JSON.stringify(e.findDialog.findParam),e.findDialog.visible=!1,k(e.activeName)},k=async t=>{const n=e.dataTabs[t].findParam;let i,r;try{i=n.filter?JSON.parse(n.filter):{},r=n.sort?JSON.parse(n.sort):{}}catch{C.error("filter\u6216sort\u5B57\u6BB5json\u5B57\u7B26\u4E32\u503C\u9519\u8BEF\u3002\u6CE8\u610F: json key\u9700\u53CC\u5F15\u53F7");return}const b=await g.findCommand.request({id:e.mongoId,database:e.database,collection:t,filter:i,sort:r,limit:n.limit||12,skip:n.skip||0});e.dataTabs[t].datas=re(b)},re=t=>{const a=[];if(!t)return a;for(let n of t)a.push({value:JSON.stringify(n,null,4)});return a},ce=()=>{const t=e.dataTabs[e.activeName].datas[0];let a="";if(t){const n=JSON.parse(t.value);delete n._id,a=JSON.stringify(n,null,4)}e.insertDocDialog.doc=a,e.insertDocDialog.visible=!0},me=async()=>{let t;try{t=JSON.parse(e.insertDocDialog.doc)}catch{C.error("\u6587\u6863\u5185\u5BB9\u9519\u8BEF,\u65E0\u6CD5\u89E3\u6790\u4E3Ajson\u5BF9\u8C61")}const a=await g.insertCommand.request({id:e.mongoId,database:e.database,collection:e.activeName,doc:t});J(a.InsertedID,"\u65B0\u589E\u5931\u8D25"),C.success("\u65B0\u589E\u6210\u529F"),k(e.activeName),e.insertDocDialog.visible=!1},fe=t=>{e.jsoneditorDialog.item=t,e.jsoneditorDialog.doc=t.value,e.jsoneditorDialog.visible=!0},pe=()=>{e.jsoneditorDialog.item.value=JSON.stringify(JSON.parse(e.jsoneditorDialog.doc),null,4)},be=async t=>{const a=G(t),n=a._id;W(n,"\u6587\u6863\u7684_id\u5C5E\u6027\u4E0D\u5B58\u5728"),delete a._id;const i=await g.updateByIdCommand.request({id:e.mongoId,database:e.database,collection:e.collection,docId:n,update:{$set:a}});J(i.ModifiedCount==1,"\u4FEE\u6539\u5931\u8D25"),C.success("\u4FDD\u5B58\u6210\u529F")},ge=async t=>{const n=G(t)._id;W(n,"\u6587\u6863\u7684_id\u5C5E\u6027\u4E0D\u5B58\u5728");const i=await g.deleteByIdCommand.request({id:e.mongoId,database:e.database,collection:e.collection,docId:n});J(i.DeletedCount==1,"\u5220\u9664\u5931\u8D25"),C.success("\u5220\u9664\u6210\u529F"),k(e.activeName)},G=t=>{try{return JSON.parse(t)}catch(a){throw C.error("\u6587\u6863\u5185\u5BB9\u89E3\u6790\u4E3Ajson\u5BF9\u8C61\u5931\u8D25"),a}},_e=t=>{const a=t.props.name;e.collection=a},ve=t=>{const a=Object.keys(e.dataTabs);let n=e.activeName;a.forEach((i,r)=>{if(i===t){const b=a[r+1]||a[r-1];b&&(n=b)}}),e.activeName=n,n==t?e.collection="":e.collection=n,delete e.dataTabs[t]},Q=async t=>{const{tagPath:a,dbId:n,db:i}=t.dbOptInfo;e.query.tagPath=a,await L(),e.mongoId=n,await R(),e.database=i,await z(),e.collection&&(e.collection="",e.dataTabs={})};let H=$.state.mongoDbOptInfo;return H.dbOptInfo.tagPath&&Q(H),he($.state.mongoDbOptInfo,async t=>{await Q(t)}),(t,a)=>{const n=d("el-option"),i=d("el-select"),r=d("el-form-item"),b=d("el-form"),U=d("el-col"),F=d("el-row"),w=d("el-link"),y=d("el-input"),K=d("el-divider"),ye=d("el-popconfirm"),De=d("el-card"),Ve=d("el-tab-pane"),Ce=d("el-tabs"),Be=d("el-container"),P=d("el-button"),q=d("el-dialog");return c(),_("div",null,[p("div",Oe,[o(F,{type:"flex",justify:"space-between"},{default:s(()=>[o(U,{span:24},{default:s(()=>[o(b,{class:"search-form","label-position":"right",inline:!0},{default:s(()=>[o(r,{label:"\u6807\u7B7E"},{default:s(()=>[o(i,{onChange:te,onFocus:oe,modelValue:u(A).tagPath,"onUpdate:modelValue":a[0]||(a[0]=l=>u(A).tagPath=l),placeholder:"\u8BF7\u9009\u62E9\u6807\u7B7E",filterable:"",style:{width:"250px"}},{default:s(()=>[(c(!0),_(D,null,V(u(Y),l=>(c(),v(n,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(r,{label:"\u5B9E\u4F8B","label-width":"40px"},{default:s(()=>[o(i,{modelValue:u(T),"onUpdate:modelValue":a[1]||(a[1]=l=>I(T)?T.value=l:null),placeholder:"\u8BF7\u9009\u62E9mongo",onChange:ne},{default:s(()=>[(c(!0),_(D,null,V(u(Z),l=>(c(),v(n,{key:l.id,label:l.name,value:l.id},{default:s(()=>[p("span",je,O(l.name),1),p("span",Se,O(`
                                                                            [${l.uri}]`),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(r,{label:"\u5E93","label-width":"20px"},{default:s(()=>[o(i,{modelValue:u(j),"onUpdate:modelValue":a[2]||(a[2]=l=>I(j)?j.value=l:null),placeholder:"\u8BF7\u9009\u62E9\u5E93",onChange:se,filterable:""},{default:s(()=>[(c(!0),_(D,null,V(u(ee),l=>(c(),v(n,{key:l.Name,label:l.Name,value:l.Name},{default:s(()=>[p("span",Ue,O(l.Name),1),p("span",qe,O(` [${u(ke)(l.SizeOnDisk)}]`),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(r,{label:"\u96C6\u5408","label-width":"40px"},{default:s(()=>[o(i,{modelValue:u(S),"onUpdate:modelValue":a[3]||(a[3]=l=>I(S)?S.value=l:null),placeholder:"\u8BF7\u9009\u62E9\u96C6\u5408",onChange:ue,filterable:""},{default:s(()=>[(c(!0),_(D,null,V(u(ae),l=>(c(),v(n,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),o(Be,{id:"data-exec",style:{border:"1px solid #eee","margin-top":"1px"}},{default:s(()=>[o(Ce,{onTabRemove:ve,onTabClick:_e,style:{width:"100%","margin-left":"5px"},modelValue:u(B),"onUpdate:modelValue":a[5]||(a[5]=l=>I(B)?B.value=l:null)},{default:s(()=>[(c(!0),_(D,null,V(u(le),l=>(c(),v(Ve,{closable:"",key:l.name,label:l.name,name:l.name},{default:s(()=>[u(T)?(c(),v(F,{key:0},{default:s(()=>[o(w,{onClick:a[4]||(a[4]=f=>k(u(B))),icon:"refresh",underline:!1,class:"ml5"}),o(w,{onClick:ce,class:"ml5",type:"primary",icon:"plus",underline:!1})]),_:1})):Ie("",!0),o(F,{class:"mt5 mb5"},{default:s(()=>[o(y,{ref_for:!0,ref_key:"findParamInputRef",ref:M,modelValue:l.findParamStr,"onUpdate:modelValue":f=>l.findParamStr=f,placeholder:"\u70B9\u51FB\u8F93\u5165\u76F8\u5E94\u67E5\u8BE2\u6761\u4EF6",onFocus:f=>ie(l.name)},{prepend:s(()=>[N("\u67E5\u8BE2\u53C2\u6570")]),_:2},1032,["modelValue","onUpdate:modelValue","onFocus"])]),_:2},1024),o(F,null,{default:s(()=>[(c(!0),_(D,null,V(l.datas,f=>(c(),v(U,{span:6,key:f},{default:s(()=>[o(De,{"body-style":{padding:"0px",position:"relative"}},{default:s(()=>[o(y,{type:"textarea",modelValue:f.value,"onUpdate:modelValue":h=>f.value=h,rows:12},null,8,["modelValue","onUpdate:modelValue"]),p("div",Je,[p("div",null,[o(w,{onClick:h=>fe(f),underline:!1,type:"success",icon:"MagicStick"},null,8,["onClick"]),o(K,{direction:"vertical","border-style":"dashed"}),o(w,{onClick:h=>be(f.value),underline:!1,type:"warning",icon:"DocumentChecked"},null,8,["onClick"]),o(K,{direction:"vertical","border-style":"dashed"}),o(ye,{onConfirm:h=>ge(f.value),title:"\u786E\u5B9A\u5220\u9664\u8BE5\u6587\u6863?"},{reference:s(()=>[o(w,{underline:!1,type:"danger",icon:"DocumentDelete"})]),_:2},1032,["onConfirm"])])])]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(q,{width:"600px",title:"find\u53C2\u6570",modelValue:u(m).visible,"onUpdate:modelValue":a[11]||(a[11]=l=>u(m).visible=l)},{footer:s(()=>[p("div",null,[o(P,{onClick:a[10]||(a[10]=l=>u(m).visible=!1)},{default:s(()=>[N("\u53D6 \u6D88")]),_:1}),o(P,{onClick:de,type:"primary"},{default:s(()=>[N("\u786E \u5B9A")]),_:1})])]),default:s(()=>[o(b,{"label-width":"70px"},{default:s(()=>[o(r,{label:"filter"},{default:s(()=>[o(y,{modelValue:u(m).findParam.filter,"onUpdate:modelValue":a[6]||(a[6]=l=>u(m).findParam.filter=l),type:"textarea",rows:6,clearable:"","auto-complete":"off"},null,8,["modelValue"])]),_:1}),o(r,{label:"sort"},{default:s(()=>[o(y,{modelValue:u(m).findParam.sort,"onUpdate:modelValue":a[7]||(a[7]=l=>u(m).findParam.sort=l),type:"textarea",rows:3,clearable:"","auto-complete":"off"},null,8,["modelValue"])]),_:1}),o(r,{label:"limit"},{default:s(()=>[o(y,{modelValue:u(m).findParam.limit,"onUpdate:modelValue":a[8]||(a[8]=l=>u(m).findParam.limit=l),modelModifiers:{number:!0},type:"number","auto-complete":"off"},null,8,["modelValue"])]),_:1}),o(r,{label:"skip"},{default:s(()=>[o(y,{modelValue:u(m).findParam.skip,"onUpdate:modelValue":a[9]||(a[9]=l=>u(m).findParam.skip=l),modelModifiers:{number:!0},type:"number","auto-complete":"off"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(q,{width:"60%",title:`\u65B0\u589E'${u(B)}'\u96C6\u5408\u6587\u6863`,modelValue:u(E).visible,"onUpdate:modelValue":a[14]||(a[14]=l=>u(E).visible=l),"close-on-click-modal":!1},{footer:s(()=>[p("div",null,[o(P,{onClick:a[13]||(a[13]=l=>u(E).visible=!1)},{default:s(()=>[N("\u53D6 \u6D88")]),_:1}),o(P,{onClick:me,type:"primary"},{default:s(()=>[N("\u786E \u5B9A")]),_:1})])]),default:s(()=>[o(X,{modelValue:u(E).doc,"onUpdate:modelValue":a[12]||(a[12]=l=>u(E).doc=l),language:"json"},null,8,["modelValue"])]),_:1},8,["title","modelValue"]),o(q,{width:"60%",title:"json\u7F16\u8F91\u5668",modelValue:u(x).visible,"onUpdate:modelValue":a[16]||(a[16]=l=>u(x).visible=l),onClose:pe,"close-on-click-modal":!1},{default:s(()=>[o(X,{modelValue:u(x).doc,"onUpdate:modelValue":a[15]||(a[15]=l=>u(x).doc=l),language:"json"},null,8,["modelValue"])]),_:1},8,["modelValue"]),$e])}}});export{Ke as default};
